%% MARK: Class Options
% Flags for packages
\bool_new:N	\g_coursework_loadcode_bool	% Algorithm/Source code formatting
\bool_new:N	\g_coursework_loaddiag_bool	% TikZ, pgfplots, etc

% Set flags to FALSE by default
\bool_gset_false:N	\g_coursework_loadcode_bool
\bool_gset_false:N	\g_coursework_loaddiag_bool

% Provide class options to load packages
\DeclareOption{code}{\bool_gset_true:N \g_coursework_loadcode_bool}
\DeclareOption{diagram}{\bool_gset_true:N \g_coursework_loaddiag_bool}

% Font
\bool_new:N \g_coursework_cmufont_bool
\bool_gset_false:N \g_coursework_cmufont_bool
\DeclareOption{cmu}{
	\bool_gset_true:N \g_coursework_cmufont_bool
}

% Pass all remaining options to parent class
\DeclareOption*{
	\PassOptionsToClass{\CurrentOption}{\c__coursework_class_parent_class_tl}
}
\ProcessOptions\relax

%% MARK: Load Parent Class
\LoadClass[letterpaper, 10pt]{\c__coursework_class_parent_class_tl}

%% Load Common Packages
\RequirePackage[
	top = 1.45in,
	bottom = 1.35in,
	inner = 1.5in,
	outer = 2in,
	marginparwidth=1.4in,
	marginparsep=0.25in
]{geometry}
\RequirePackage{framed}
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage[overload]{textcase}
\RequirePackage[titles]{tocloft}
\RequirePackage{fancyhdr}
\RequirePackage[side,flushmargin]{footmisc}
\RequirePackage{enumitem}
\RequirePackage{hyperref}
\RequirePackage{xcolor}
\RequirePackage{xpatch}
\RequirePackage{graphicx}

% Mathematics
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{thmtools}
\RequirePackage{mathtools}
\RequirePackage{bm}

% Physics
\RequirePackage{physics}
\RequirePackage{siunitx}
\RequirePackage{tensor}

% Chemistry
\RequirePackage[version=4]{mhchem}

% Computer Science
\bool_if:NT	\g_coursework_loadcode_bool {
	\RequirePackage{minted} \usemintedstyle{tango}
	\RequirePackage{algorithm}
	\RequirePackage{algpseudocode}
}

% Diagrams
\bool_if:NT	\g_coursework_loaddiag_bool {
	\RequirePackage{tikz}
	\RequirePackage{pgfplots}
	\RequirePackage[american, siunitx]{circuitikz}
	\RequirePackage{tikz-feynman}
	\RequirePackage{chemfig}

	\ctikzset{bipoles/thickness=1}
	\pgfplotsset{compat=1.15}
}

%% MARK: Fonts
\ifPDFTeX
	% Allow UTF-8 characters
	\RequirePackage[utf8]{inputenc}
	\RequirePackage[T1]{fontenc}
	
	% Adjust kerning
	\RequirePackage[letterspace=100]{microtype}

	% Create empty macro for kerning
	\NewDocumentCommand\widekern{ } {\lsstyle}

	% Load pdflatex Palatino
	\bool_if:NTF \g_coursework_cmufont_bool {\RequirePackage{lmodern}} {\RequirePackage{libertineRoman}}

	\def\ipafont\relatex
	\NewDocumentCommand\ipafont{ }{}
	\NewDocumentCommand\setipafont{ m }{}
	\NewDocumentCommand\ipa{ m }{}
\else
	% Load fontspec
	\RequirePackage[no-math]{fontspec}

	% Wide kerning for title page / sections
	\bool_if:NTF \g_coursework_cmufont_bool {
		\NewDocumentCommand\widekern{ } {\addfontfeatures{LetterSpace=8}}
		\setmainfont[
			ItalicFont={CMUSerif-Italic},
			BoldFont={CMUSerif-Bold},
			BoldItalicFont={CMUSerif-BoldItalic},
			SlantedFont={CMUSerif-RomanSlanted},
			BoldSlantedFont={CMUSerif-BoldSlanted},
			Ligatures={Common, Discretionary, Contextual},
		]{CMUSerif-Roman}
	} {
		\NewDocumentCommand\widekern{ } {\addfontfeatures{LetterSpace=10}}
		\setmainfont[
			ItalicFont={LinLibertineOI},
			BoldFont={LinLibertineOB},
			BoldItalicFont={LinLibertineOBI},
			Ligatures={Common, Discretionary, Contextual},
		]{LinLibertineO}
	}

	\setmonofont[
		ItalicFont={CMUTypewriter-Italic},
		BoldFont={CMUTypewriter-Bold},
		BoldItalicFont={CMUTypewriter-BoldItalic},
		SlantedFont={CMUTypewriter-Oblique}
	]{CMUTypewriter-Regular}

	% Define ipafont
	\newfontfamily\ipafont{LinLibertineO}[
			BoldFont={LinLibertineOB},
			BoldItalicFont={LinLibertineOBI},
			Ligatures={Common, Discretionary, Contextual},
	]
	\NewDocumentCommand\setipafont{ m }{
		\newfontfamily\ipafont{#1}
	}
	\NewDocumentCommand\ipa{ m }{{\ipafont #1}}
\fi

%% Define Linguistics commands
\NewDocumentCommand\phon{ m }{$/${\ipafont #1}$/$}
\NewDocumentCommand\allo{ m }{$[${\ipafont #1}$]$}
\NewDocumentCommand\orth{ m }{$\langle${\ipafont #1}$\rangle$}
\NewDocumentCommand\where{ }{$\big/$}

% Define line spacing
\NewDocumentCommand\normalspacing{ } {\renewcommand{\baselinestretch}{1.2}}
\NewDocumentCommand\tightspacing{ }  {\renewcommand{\baselinestretch}{0.8}}
\normalspacing

% Define Colors
% Link colors
\definecolor{linkblue}{HTML}{2364AA}
\definecolor{linkred}{HTML}{B52639}
\definecolor{linkgold}{HTML}{C1900B}
\definecolor{yaleblue}{HTML}{00356B}
\definecolor{backgroundgold}{rgb}{1,0.93,0.8}
\definecolor{backgroundgrey}{rgb}{0.95,0.95,0.95}

\hypersetup{
  linkcolor  = yaleblue,
  citecolor  = yaleblue,
  urlcolor   = yaleblue,
  colorlinks = true,
}

%% Define custom commands
% Margin Notes
\NewDocumentCommand\note{ m } {
	\tightspacing
	\marginpar{\textit{\footnotesize{#1}}}
	\normalspacing
}

% Footnotes
\let\oldfootnote\footnote
\RenewDocumentCommand\footnote{ m } {\oldfootnote{\textit{#1}}}

% Final box
\NewDocumentCommand\final{ m } {\boxed{#1}}

% Custom math commands
\NewDocumentCommand\R{} {\mathbb{R}}
\ifxetex \RenewDocumentCommand\C{} {\mathbb{C}} \else \NewDocumentCommand\C{} {\mathbb{C}} \fi
\NewDocumentCommand\Z{} {\mathbb{Z}}
\NewDocumentCommand\Q{} {\mathbb{Q}}
\NewDocumentCommand\N{} {\mathbb{N}}
\NewDocumentCommand\F{} {\mathbb{F}}


% Custom units
\DeclareSIUnit{\mile}{mi}
\DeclareSIUnit{\gallon}{gallon}
\DeclareSIUnit{\pound}{lb}
\DeclareSIUnit{\foot}{ft}
\DeclareSIUnit{\atmosphere}{atm}
\DeclareSIUnit{\fahrenheit}{\ensuremath{{}^{\circ}
 \text{F}}}
\DeclareSIUnit{\atom}{at}
\DeclareSIUnit{\molecule}{molecule}
\DeclareSIUnit{\calorie}{cal}
\DeclareSIUnit{\Calorie}{Cal}
\DeclareSIUnit{\inch}{in}

% Unit vector formatting
\NewDocumentCommand\unit{ m } {\bm{\hat{\mathbf{#1}}}}

% Parts environment
\NewDocumentEnvironment{parts}{ }
		               {\begin{enumerate}[label=\textup{(\alph*)},
		                                  labelwidth=4.5em,
		                                  labelsep=0.5em,
		                                  leftmargin=2\parindent,
		                                  topsep=0.5em,
		                                  % partopsep=1.5em,
		                                  itemsep=0em,
		                                  resume]}
		               {\end{enumerate}}

% \part[]
\RenewDocumentCommand\part{ o }{\IfNoValueTF{#1}
                                            {\item}
                                            {\item\label{#1}}}

%% Define Theorem-like environments
% QED Symbol
\RenewDocumentCommand\qedsymbol{}{$\blacksquare$}

% Make shaded theorems have uniform padding
\NewDocumentCommand\headpadding{}{\leftskip=0.4cm\rightskip=0.4cm\vspace{0.4cm}}
\NewDocumentCommand\footpadding{}{\vspace{0.4cm}}
% \NewDocumentCommand\theoremvert{}{0.6em}
\NewDocumentCommand\theoremvert{}{0em}

\makeatletter
\renewenvironment{proof}[1][\proofname]{\par
  \vspace{-\parskip}% remove the space after the theorem
  \pushQED{\qed}%
  \normalfont
  % \topsep0pt \partopsep0pt % no space before
  \topsep1em \partopsep0pt
  \trivlist
  \item[\hskip\labelsep
        \itshape
    #1\@addpunct{.}]\ignorespaces
}{%
  \popQED\endtrivlist\@endpefalse
  % \addvspace{6pt plus 6pt} % some space after
  \vspace{-\topsep}
}
\makeatother

% Solution (clone of proof)
\NewDocumentEnvironment{solution}{ o }
                       {\IfNoValueTF{#1}{\begin{proof}[Solution]}{\begin{proof}[#1]}}
                       {\end{proof}}


% Lemma style definition
\declaretheoremstyle[
	spaceabove=1em, spacebelow=0em,
	headfont=\normalfont\bfseries,
	bodyfont=\normalfont\itshape
]{lemma}

\declaretheorem[style=lemma]{lemma}
\declaretheorem[style=lemma]{theorem}
\declaretheorem[style=lemma]{corollary}
\declaretheorem[style=lemma]{conjecture}

% Definition style theorems
\declaretheoremstyle[
	% spaceabove=\theoremvert, spacebelow=\theoremvert,
	spaceabove=1em, spacebelow=0em,
	headfont=\normalfont\bfseries,
	bodyfont=\normalfont
]{definition}

\declaretheorem[
	style=definition,
	postheadhook=\leftskip=1cm\rightskip=1cm
]{definition}
\declaretheorem[
	style=definition,
	postheadhook=\leftskip=1cm\rightskip=1cm,
	numbered=no
]{notation}
\declaretheorem[
	style=definition,
	postheadhook=\leftskip=1cm\rightskip=1cm,
	title={Abuse~of~Notation},
	numbered=no
]{abuse}
\declaretheorem[
	shaded={bgcolor=backgroundgrey},
	style=definition,
	postheadhook=\headpadding\hspace{1em},
	postfoothook=\footpadding,
]{problem}
\declaretheorem[
	shaded={bgcolor=backgroundgrey},
	style=definition,
	postheadhook=\headpadding\hspace{1em},
	postfoothook=\footpadding,
	sibling=problem
]{exercise}

% Break style theorems
\declaretheoremstyle[
	spaceabove=\theoremvert, spacebelow=\theoremvert,
	headfont=\normalfont\bfseries,
	bodyfont=\normalfont,
	postheadspace=\newline
]{break}

\declaretheorem[
	shaded={bgcolor=backgroundgold},
	style=break,
	postheadhook=\headpadding,
	postfoothook=\footpadding
]{example}